<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <title>聊天室</title>  
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>  
    <script src="/socket.io/socket.io.js"></script>  
    <style>  
        html,body {  
            background: #ccc;  
            padding: 20px 0 20px 0;  
        }  
        h1 {  
            text-align: center;  
        }  
        .login {  
            text-align: center;  
        }  
        .chatinput {  
            display: block;  
            width: 100%;  
            position: absolute;  
            min-height: 30px;  
            bottom: 0;  
        }  
        #content {  
            height: auto;  
        }  
    </style>  
</head>  
<body>  
<div id="loginbox">  
    <h1>登录</h1>  
    <hr>  
    <div class="login">  
        <lable>用户名：</lable><input type="text" id="name"><br><br>  
        <input type="button" value="登录" id="loginbutton">  
    </div>  
</div>  
<div style="display: none;" id="chatbox">  
    <div id="content"></div>  
    <input type="text" placeholder="saying somgthing" class="chatinput" id="chatinput">  
</div>  
</body>  
<script>
    $(function(){  
    // const url = 'http://127.0.0.1:3000';  
    let _username = null;  
    let _$inputname = $("#name");  
    let _$loginButton = $("#loginbutton");  
    let _$chatinput = $("#chatinput");  
  
    // let socket = io.connect(url); 
    var socket = io();
    

  
    //设置用户名，当用户登录的时候触发  
    let setUsername = function () {  
        _username = _$inputname.val().trim();    //得到输入框中用户输入的用户名  
  
        //判断用户名是否存在  
        if(_username) {  
            socket.emit('login',{username: _username});   //如果用户名存在，就代表可以登录了，我们就触发登录事件，就相当于告诉服务器我们要登录了  
        }  
    };  
      
      
      
    /*前端事件*/  
    _$loginButton.on('click',function (event) {    //监听按钮的点击事件，如果点击，就说明用户要登录，就执行setUsername函数  
        setUsername();  
    });  
      
    _$inputname.on('keyup',function (event) {     //监听输入框的回车事件，这样用户回车也能登录。  
        if(event.keyCode === 13) {                //如果用户输入的是回车键，就执行setUsername函数  
            setUsername();  
        }  
    })  

   socket.on('loginok', function(msg){
    if(_$inputname.val().trim() === msg.username){
        beginChat();
    }else{
        alert("登录失败");
    }
   })

    let beginChat = function () { 
         /** 
     * 1.隐藏登录框，取消它绑定的事件 
     * 2.显示聊天界面 
     */  
        $("#loginbox").hide('slow');  
        _$inputname.off('keyup');  
        _$loginButton.off('click');  
        /** 
         * 显示聊天界面，并显示一行文字，欢迎用户 
         * 这里我使用了ES6的语法``中可以使用${}在里面写的变量可以直接被浏览器渲染 
         */  
        $(`<p>欢迎你${_username}</p>`).insertBefore($("#content"));  
        $("#chatbox").show('slow');
    }

    let sendMessage = function () {  
        /** 
         * 得到输入框的聊天信息，如果不为空，就触发sendMessage 
         * 将信息和用户名发送过去 
         */  
        let _message = _$chatinput.val();  
      
        if(_message) {  
            socket.emit('sendMessage',{username: _username, message: _message});  
        }  
    };

    _$chatinput.on('keyup',function (event) {  
        if(event.keyCode === 13) {  
            sendMessage();  
            _$chatinput.val('');  
        }  
    });

    socket.on('receiveMessage',function(data){
        console.log(data.message);
        console.log(data.username);
        showMessage(data);
    })

    let showMessage = function (data) {  
    //先判断这个消息是不是自己发出的，然后再以不同的样式显示  
    if(data.username === _username){  
        $("#content").append(`<p style='background: lightskyblue'><span>${data.username} : </span> ${data.message}</p>`);  
    }else {  
        $("#content").append(`<p style='background: lightpink'><span>${data.username} : </span> ${data.message}</p>`);  
    }  
};
  
});  
</script>
</html>